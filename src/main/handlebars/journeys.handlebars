{{#> layout}}
  {{#*inline "title"}}Reisen{{/inline}}
  {{#*inline "meta"}}
    <meta property="og:url" content="{{request.uri}}">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Reisen - Dialog">
    <meta property="og:description" content="Fotoblog von Timm Friebe">
    {{#with journeys.0}}
      <meta property="og:image" content="{{request.uri.base}}/image/{{slug}}/preview-{{images.0.name}}.jpg">
    {{/with}}
  {{/inline}}
  {{#*inline "main"}}
    <div id="map" class="full">
      <div class="popup"></div>
    </div>

    <h2 class="news">Nach Datum</h2>
    <div class="cards">
      {{#each journeys}}
        <div class="card">
          <div class="date">{{range is.from is.until format="M Y"}}</div>
          <a title="{{title}}" href="/journey/{{slug}}">
            {{#with images.0}}<img src="/image/{{slug}}/thumb-{{.}}.webp">{{/with}}
            <h3>{{title}}</h3>
          </a>
        </div>
      {{/each}}
    </div>
  {{/inline}}
  {{#*inline "scripts"}}
    <script type="module">
      const markers = {
        style : new ol.style.Style({image: new ol.style.Icon(({src: '/static/marker.png'}))}),
        list  : [],
        add   : function(link, lon, lat, name) {
          const marker = new ol.Feature({
            geometry : new ol.geom.Point(ol.proj.fromLonLat([lon, lat])),
            link     : link,
            name     : name
          });
          marker.setStyle(markers.style);
          markers.list.push(marker);
        }
      };

      {{#each journeys}}
        {{#each locations}}
          markers.add('/journey/{{slug}}', {{lon}}, {{lat}}, `{{title}}: {{name}}`);
        {{/each}}
      {{/each}}

      const source = new ol.source.Vector({features: markers.list});
      const map = new ol.Map({
        target: 'map',
        layers: [new ol.layer.Tile({source: new ol.source.OSM()})]
      });
      map.addLayer(new ol.layer.Vector({source: source}));
      map.getView().fit(source.getExtent(), {padding: [24, 24, 24, 24], minResolution: 30});

      const $popup = document.querySelector('#map .popup');
      map.on('movestart', event => {
        $popup.style.display = 'none';
      });
      map.on('click', event => {
        $popup.style.display = 'none';
        const items = [];
        map.forEachFeatureAtPixel(event.pixel, feature => {
          items.push(`<li><a href="${feature.get('link')}">${feature.get('name')}</a></li>`);
        })
        if (0 === items.length) return;

        $popup.innerHTML = '<ul>' + items.join('') + '</ul>';
        $popup.style.left = event.pixel[0] + 'px';
        $popup.style.top = event.pixel[1] + 'px';
        $popup.style.display = 'block';
      });
    </script>
  {{/inline}}
{{/layout}}